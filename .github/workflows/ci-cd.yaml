name: CI/CD

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo

jobs:
  scan:
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:community
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
        ports: [ "9000:9000" ]

    steps:
      - uses: actions/checkout@v4

      - name: Wait SonarQube ready
        run: |
          set -e
          for i in {1..120}; do
            if curl -sf http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"; exit 0
            fi
            echo "Waiting SonarQube... ($i/120)"; sleep 5
          done
          echo "SonarQube not ready in time" >&2; exit 1

      - name: Create temp token
        run: |
          set -e
          TOKEN_JSON=$(curl -sf -u admin:admin -X POST "http://localhost:9000/api/user_tokens/generate?name=ci$(date +%s)")
          TOKEN=$(echo "$TOKEN_JSON" | jq -r .token)
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Cannot create Sonar token"; exit 1
          fi
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$TOKEN"

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: http://localhost:9000
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=nginx-demo
            -Dsonar.sources=./web
            -Dsonar.sourceEncoding=UTF-8
