name: CI CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  sonar-scan:
    runs-on: self-hosted
    steps:
      - name: Ensure admin password & create CI token
        run: |
          set -e
          HOST=http://localhost:9000

          echo "➡️  Checking SonarQube availability..."
          curl -sf "$HOST/api/system/status" | grep -q '"status":"UP"' || { echo "❌ SonarQube not UP"; exit 1; }

          echo "➡️  Resetting admin password (safe ignore if already set)"
          curl -sf -u admin:admin -X POST "$HOST/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true

          echo "➡️  Generating new CI token..."
          TOK_JSON=$(curl -sf -u admin:admin123 -X POST "$HOST/api/user_tokens/generate?name=ci$(date +%s)" || true)
          echo "Raw response: $TOK_JSON"

          if [ -z "$TOK_JSON" ]; then
            echo "❌ Failed to get token JSON"; exit 1;
          fi

          TOKEN=$(echo "$TOK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin).get('token',''))")
          if [ -z "$TOKEN" ]; then
            echo "❌ No token parsed from response"; exit 1;
          fi

          echo "SONAR_HOST_URL=$HOST" >> $GITHUB_ENV
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$TOKEN"
          echo "✅ Token created successfully"


  build-and-push:
    runs-on: self-hosted
    needs: sonar-scan
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: ./web
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest

  deploy:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - name: kubectl set image & rollout
        run: |
          kubectl -n demo set image deployment/nginx-demo nginx=${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest
          kubectl -n demo rollout status deployment/nginx-demo --timeout=120s
