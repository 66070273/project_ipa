name: CI/CD

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo

jobs:
  # 1) Code Scan with SonarQube (รอ service แบบ HTTP polling)
  scan:
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:community
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
        ports:
          - 9000:9000
    steps:
      - uses: actions/checkout@v4

      - name: Wait SonarQube HTTP ready
        run: |
          set -e
          for i in {1..120}; do   # ~10 นาที
            code=$(curl -s -o /dev/null -w "%{http_code}" http://sonarqube:9000/api/system/status || true)
            if [ "$code" = "200" ] && curl -sf http://sonarqube:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"; exit 0
            fi
            echo "Waiting SonarQube... ($i)"; sleep 5
          done
          echo "SonarQube not ready in time" >&2; exit 1

      # ถ้ามี secret token อยู่แล้วให้ใช้ secrets.SONAR_TOKEN และลบขั้นตอน create token นี้ทิ้ง
      - name: Create temp token (demo)
        id: mk_token
        run: |
          set -e
          TOKEN_JSON=$(curl -sf -u admin:admin -X POST "http://sonarqube:9000/api/user_tokens/generate?name=ci$(date +%s)")
          TOKEN=$(echo "$TOKEN_JSON" | jq -r .token)
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$TOKEN"

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: http://sonarqube:9000
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}   # หรือ ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=nginx-demo
            -Dsonar.sources=./web
            -Dsonar.sourceEncoding=UTF-8

  # 2) Build & Push Docker
  build_push:
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # 3) Deploy (เลือกใช้วิธีเข้าถึงคลัสเตอร์อย่างใดอย่างหนึ่ง)
  deploy:
    runs-on: ubuntu-latest
    needs: build_push
    steps:
      - uses: actions/checkout@v4

      # วิธี A: runner เข้าถึงคลัสเตอร์ได้ตรง ๆ (มี kubeconfig ใน secret)
      - name: Write kubeconfig
        if: ${{ secrets.KUBE_CONFIG != '' }}
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set image & rollout
        if: ${{ secrets.KUBE_CONFIG != '' }}
        run: |
          kubectl -n demo set image deployment/nginx-demo nginx=${{ env.IMAGE_NAME }}:${{ github.sha }}
          kubectl -n demo rollout status deployment/nginx-demo --timeout=120s

      # วิธี B: SSH เข้า jump host / เครื่องที่มี kubectl (ถ้าใช้ minikube บนเครื่องตัวเอง)
      # - name: Deploy via SSH
      #   if: ${{ secrets.SSH_HOST != '' }}
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     key: ${{ secrets.SSH_KEY }}
      #     script: |
      #       kubectl -n demo set image deployment/nginx-demo nginx=${{ env.IMAGE_NAME }}:${{ github.sha }}
      #       kubectl -n demo rollout status deployment/nginx-demo --timeout=120s
