name: CI/CD

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo

jobs:
  scan:
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:community
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
        ports:
          - 9000:9000
        options: >-
          --health-cmd="curl -fsS http://localhost:9000/api/system/status | grep -q '\"status\":\"UP\"'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=120

    steps:
      - uses: actions/checkout@v4

      # รอจน service พร้อม (เช็คผ่าน localhost เพราะ step นี้รันบน host runner)
      - name: Wait SonarQube HTTP ready
        run: |
          set -e
          for i in {1..240}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/api/system/status || true)
            if [ "$code" = "200" ] && curl -sf http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"; exit 0
            fi
            echo "Waiting SonarQube... ($i)"; sleep 5
          done
          echo "SonarQube not ready in time" >&2; exit 1

      # ❌ ลบขั้นตอน Create temp token ทิ้ง (เราใช้ secrets แทน)
      # ✅ ใช้ secrets ทั้งคู่นี้: SONAR_HOST_URL, SONAR_TOKEN
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}   # ต้องตั้งค่าเป็น http://sonarqube:9000
          SONAR_TOKEN:     ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=nginx-demo
            -Dsonar.sources=./web
            -Dsonar.sourceEncoding=UTF-8
