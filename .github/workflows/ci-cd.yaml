name: CI/CD

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo

jobs:
  # 1) Code Scan with SonarQube
  scan:
  runs-on: ubuntu-latest
  services:
    sonarqube:
      image: sonarqube:community
      env:
        SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      ports:
        - 9000:9000
      options: >-
        --health-cmd="curl -fsS http://localhost:9000/api/system/status | grep -q '\"status\":\"UP\"'"
        --health-interval=10s
        --health-timeout=5s
        --health-retries=120

  steps:
    - uses: actions/checkout@v4

    - name: Wait SonarQube HTTP ready
      run: |
        set -e
        for i in {1..240}; do
          code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/api/system/status || true)
          if [ "$code" = "200" ] && curl -sf http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
            echo "SonarQube is UP"; exit 0
          fi
          echo "Waiting SonarQube... ($i)"; sleep 5
        done
        echo "SonarQube not ready in time" >&2; exit 1

    # ครั้งแรก SonarQube บังคับให้เปลี่ยนรหัส admin; เปลี่ยนผ่าน API ให้เรียบร้อย
    - name: Set admin password (first-run)
      run: |
        set -e
        HOST=http://localhost:9000
        curl -sf -u admin:admin -X POST \
          "$HOST/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true

    # สร้างโทเคนชั่วคราวจาก admin ที่เพิ่งตั้ง
    - name: Create CI token
      run: |
        set -e
        HOST=http://localhost:9000
        TOKEN_JSON=$(curl -sf -u admin:admin123 -X POST "$HOST/api/user_tokens/generate?name=ci$(date +%s)")
        TOKEN=$(echo "$TOKEN_JSON" | jq -r .token)
        echo "SONAR_HOST_URL=http://sonarqube:9000" >> $GITHUB_ENV
        echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
        echo "::add-mask::$TOKEN"

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v2
      env:
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}   # ใช้ service name
        SONAR_TOKEN:     ${{ env.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=nginx-demo
          -Dsonar.sources=./web
          -Dsonar.sourceEncoding=UTF-8
