name: CI CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  sonar-scan:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Wait SonarQube UP (http://localhost:9000)
        run: |
          set -e
          for i in {1..120}; do
            RES=$(curl -sf http://localhost:9000/api/system/status || true)
            echo "status=$RES"
            echo "$RES" | grep -q '"status":"UP"' && exit 0
            echo "Waiting... ($i)"; sleep 5
          done
          echo "SonarQube not UP"; exit 1

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install SonarScanner CLI
        run: |
          set -e
          VER=5.0.1.3006
          curl -fsSL -o scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${VER}-macosx.zip \
          || curl -fsSL -o scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${VER}-linux.zip
          unzip -q scanner.zip -d $HOME
          mv $HOME/sonar-scanner-* $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/bin" >> $GITHUB_PATH
          sonar-scanner --version

            - name: Ensure admin password & create CI token
        run: |
          set -e
          HOST=http://localhost:9000

          echo "➡️  Checking SonarQube availability..."
          curl -sf "$HOST/api/system/status" | grep -q '"status":"UP"' || { echo "❌ SonarQube not UP"; exit 1; }

          echo "➡️  Resetting admin password (safe ignore if already set)"
          curl -sf -u admin:admin -X POST "$HOST/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true

          echo "➡️  Generating new CI token..."
          TOK_JSON=$(curl -sf -u admin:admin123 -X POST "$HOST/api/user_tokens/generate?name=ci$(date +%s)" || true)
          echo "Raw response: $TOK_JSON"

          if [ -z "$TOK_JSON" ]; then
            echo "❌ Failed to get token JSON"; exit 1;
          fi

          TOKEN=$(echo "$TOK_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin).get('token',''))")
          if [ -z "$TOKEN" ]; then
            echo "❌ No token parsed from response"; exit 1;
          fi

          echo "SONAR_HOST_URL=$HOST" >> $GITHUB_ENV
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$TOKEN"
          echo "✅ Token created successfully"

      - name: Validate token
        run: |
          set -e
          echo "➡️  Validating token..."
          RES=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate" || true)
          echo "Response: $RES"
          echo "$RES" | grep -q '"valid":true' && echo "✅ Token valid" || { echo "❌ Token invalid"; exit 1; }


      - name: SonarQube Scan
        run: |
          sonar-scanner \
            -Dsonar.projectKey=nginx-demo \
            -Dsonar.sources=./web \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

  build-and-push:
    runs-on: self-hosted
    needs: sonar-scan
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: ./web
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest

  deploy:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - name: kubectl set image & rollout
        run: |
          kubectl -n demo set image deployment/nginx-demo nginx=${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest
          kubectl -n demo rollout status deployment/nginx-demo --timeout=120s
