name: CI/CD

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo

jobs:
  # 1) Code Scan with SonarQube
  scan:
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:community
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
        ports:
          - 9000:9000
        # ทำ healthcheck ให้พร้อมก่อนใช้งาน
        options: >-
          --health-cmd="curl -fsS http://localhost:9000/api/system/status | grep -q '\"status\":\"UP\"'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=120

    steps:
      - uses: actions/checkout@v4

      # รอ SonarQube (เช็คผ่าน localhost เพราะ step นี้รันบน host runner)
      - name: Wait SonarQube HTTP ready
        run: |
          set -e
          for i in {1..240}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/api/system/status || true)
            if [ "$code" = "200" ] && curl -sf http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"; exit 0
            fi
            echo "Waiting SonarQube... ($i)"; sleep 5
          done
          echo "SonarQube not ready in time" >&2; exit 1

      # ป้องกันปัญหา \r \n หรือ space ติดท้ายค่า secrets
      - name: Normalize SONAR vars from secrets
        run: |
          H=$(printf "%s" "${{ secrets.SONAR_HOST_URL }}" | tr -d '\r\n ')
          T=$(printf "%s" "${{ secrets.SONAR_TOKEN }}"    | tr -d '\r\n ')
          echo "SONAR_HOST_URL=$H" >> $GITHUB_ENV
          echo "SONAR_TOKEN=$T"    >> $GITHUB_ENV
          echo "Using SONAR_HOST_URL=$H"

      # (เลือกได้) ตรวจ token ให้ชัวร์ ถ้าไม่ valid จะ fail เร็ว
      - name: Validate Sonar token
        run: |
          set -e
          if [ -z "${SONAR_TOKEN:-}" ]; then
            echo "SONAR_TOKEN is empty. Please set a valid token in repo secrets."; exit 1
          fi
          # username=<token>, password ว่าง ตามรูปแบบ Sonar
          RES=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate" | jq -r .valid || echo "false")
          if [ "$RES" != "true" ]; then
            echo "SONAR_TOKEN is NOT valid against ${SONAR_HOST_URL}"; exit 1
          fi

      # ตัวสแกนรันใน container → ต้องเรียกผ่านชื่อ service (sonarqube) ไม่ใช่ localhost
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_TOKEN:     ${{ env.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=nginx-demo
            -Dsonar.sources=./web
            -Dsonar.sourceEncoding=UTF-8

  # 2) Build & Push Docker image
  build_push:
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # 3) Deploy to Kubernetes (optional; ทำงานเมื่อมี KUBE_CONFIG)
  deploy:
    runs-on: ubuntu-latest
    needs: build_push
    env:
      KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}  # รองรับทั้ง base64 และ YAML ตรงๆ
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          set -e
          curl -fsSL https://storage.googleapis.com/kubernetes-release/release/$(curl -fsSL https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl -o kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client=true

      - name: Write kubeconfig if secret exists
        if: ${{ env.KUBE_CONFIG_B64 != '' }}
        run: |
          mkd
