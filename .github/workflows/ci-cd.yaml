name: CI CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  sonar-scan:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      # 0) ตรวจว่า SonarQube เปิดอยู่จริง
      - name: Wait SonarQube UP (http://localhost:9000)
        run: |
          set -e
          for i in {1..120}; do
            if curl -sf http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"; exit 0
            fi
            echo "Waiting SonarQube... ($i)"; sleep 5
          done
          echo "SonarQube not ready"; exit 1

      # 1) ติดตั้ง Java 17 + SonarScanner CLI (ไม่ใช้ Docker)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Download SonarScanner CLI (macOS)
        run: |
          set -e
          SC_VER=5.0.1.3006
          curl -fsSL -o scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SC_VER}-macosx.zip"
          unzip -q scanner.zip -d $HOME
          mv $HOME/sonar-scanner-* $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/bin" >> $GITHUB_PATH

      # 2) (ครั้งแรกบางเวอร์ชันบังคับ) เปลี่ยนรหัส admin จาก admin→admin123 ถ้าทำแล้วจะไม่ error
      - name: Ensure admin password set
        run: |
          set -e
          curl -sf -u admin:admin -X POST \
            "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=admin123" || true

      # 3) สร้างโทเคน CI จาก admin บนเซิร์ฟเวอร์นี้เอง → ไม่มีโอกาส mismatch
      - name: Create CI token
        id: mk_token
        run: |
          set -e
          TOKEN_JSON=$(curl -sf -u admin:admin123 -X POST \
            "http://localhost:9000/api/user_tokens/generate?name=ci$(date +%s)")
          TOKEN=$(echo "$TOKEN_JSON" | /usr/bin/python3 -c 'import sys,json;print(json.load(sys.stdin)["token"])')
          echo "SONAR_HOST_URL=http://localhost:9000" >> $GITHUB_ENV
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$TOKEN"

      # 4) ยืนยันว่าโทเคนใช้ได้จริง
      - name: Validate CI token
        run: |
          set -e
          RES=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate" || true)
          echo "$RES" | grep -q '"valid":true' || { echo "Token not valid against ${SONAR_HOST_URL}"; exit 1; }

      # 5) สแกนจริง
      - name: SonarQube Scan
        run: |
          sonar-scanner \
            -Dsonar.projectKey=nginx-demo \
            -Dsonar.sources=./web \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"
